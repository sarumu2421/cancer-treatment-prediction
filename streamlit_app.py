import streamlit as st
import pandas as pd
import joblib   
from sklearn.metrics import accuracy_score, confusion_matrix, classification_report 
import numpy as np 
import matplotlib.pyplot as plt 
import seaborn as sns 

if "prediction" not in st.session_state:
    st.session_state.prediction = None
    st.session_state.prob = None

@st.cache_resource
def load_artifacts():
    model = joblib.load("model.joblib")
    encoders = joblib.load("encoders.joblib")
    features = joblib.load("features.joblib")
    return model, encoders, features

model, encoders, features = load_artifacts() 

st.title("Breast Cancer Treatment Response Predictor")

st.write(
    "This model estimates the likelihood that a breast cancer patient "
    "will respond to treatment based on clinical characteristics derived from the derived from the METABRIC dataset."
) 

age = st.slider("Age at Diagnosis", 20, 100, 55)
nodes = st.slider("Positive Lymph Nodes", 0, 50, 2)

cellularity = st.selectbox(
    "Cellularity",
    encoders["CELLULARITY"].classes_
)

histology = st.selectbox(
    "Histological Subtype",
    encoders["HISTOLOGICAL_SUBTYPE"].classes_
)

menopause = st.selectbox(
    "Menopausal State",
    encoders["INFERRED_MENOPAUSAL_STATE"].classes_
)

intclust = st.selectbox(
    "Integrative Cluster",
    encoders["INTCLUST"].classes_
) 

if st.button("Predict Treatment Response"):
    input_data = pd.DataFrame([[
        age,
        nodes,
        encoders["CELLULARITY"].transform([cellularity])[0],
        encoders["HISTOLOGICAL_SUBTYPE"].transform([histology])[0],
        encoders["INFERRED_MENOPAUSAL_STATE"].transform([menopause])[0],
        encoders["INTCLUST"].transform([intclust])[0],
    ]], columns=features)

    st.session_state.prob = model.predict_proba(input_data)[0][1]
    st.session_state.prediction = model.predict(input_data)[0]


if st.session_state.prediction is not None:
    if st.session_state.prediction == 1:
        st.success(
            f"Likely to respond to treatment "
            f"(Estimated probability: {st.session_state.prob:.2f})"
        )
    else:
        st.warning(
            f"Less likely to respond to treatment"
            f"(Estimated probability: {st.session_state.prob:.2f})"
        )

st.caption(
    "This prediction was generated by a machine learning model and is intended "
    "for research and educational purposes only."
) 

# Feature importance 
if st.session_state.prediction is not None:
    if st.checkbox("Show feature importance"):
        importances = pd.DataFrame({
            "Feature": features,
            "Importance": model.feature_importances_
        }).sort_values(by="Importance", ascending=False)

        fig, ax = plt.subplots()
        sns.barplot(x="Importance", y="Feature", data=importances, ax=ax)
        ax.set_title("Feature Importance")
        st.pyplot(fig)